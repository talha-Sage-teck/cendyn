/**
 * @fileoverview added by tsickle
 * Generated from: lib/io/io.service.ts
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { ChangeDetectorRef, ComponentFactoryResolver, Inject, Injectable, KeyValueDiffers, } from '@angular/core';
import { Subject } from 'rxjs';
import { takeUntil } from 'rxjs/operators';
import { createChange, createNewChange, noop } from '../util';
import { EventArgumentToken } from './event-argument';
/**
 * @record
 */
export function IOMapInfo() { }
if (false) {
    /** @type {?} */
    IOMapInfo.prototype.propName;
    /** @type {?} */
    IOMapInfo.prototype.templateName;
}
/**
 * @record
 */
export function IoInitOptions() { }
if (false) {
    /** @type {?|undefined} */
    IoInitOptions.prototype.trackOutputChanges;
}
/**
 * @record
 */
function OutputsTypeProcessed() { }
export class IoService {
    /**
     * @param {?} differs
     * @param {?} cfr
     * @param {?} eventArgument
     */
    constructor(differs, cfr, eventArgument) {
        this.differs = differs;
        this.cfr = cfr;
        this.eventArgument = eventArgument;
        this.checkInit = this.failInit;
        this.lastComponentInst = null;
        this.inputsDiffer = this.differs.find({}).create();
        this.compFactory = null;
        this.outputsShouldDisconnect$ = new Subject();
        this.outputsChanged = (/**
         * @return {?}
         */
        () => false);
    }
    /**
     * @private
     * @return {?}
     */
    get compRef() {
        return this.compInjector.componentRef;
    }
    /**
     * @private
     * @return {?}
     */
    get componentInst() {
        return this.compRef ? this.compRef.instance : null;
    }
    /**
     * @private
     * @return {?}
     */
    get componentInstChanged() {
        if (this.lastComponentInst !== this.componentInst) {
            this.lastComponentInst = this.componentInst;
            return true;
        }
        else {
            return false;
        }
    }
    /**
     * @private
     * @return {?}
     */
    get compCdr() {
        // tslint:disable-next-line: deprecation
        return this.compRef ? this.compRef.injector.get(ChangeDetectorRef) : null;
    }
    /**
     * @return {?}
     */
    ngOnDestroy() {
        this._disconnectOutputs();
    }
    /**
     * @param {?} componentInjector
     * @param {?=} options
     * @return {?}
     */
    init(componentInjector, options = {}) {
        this.checkInit = componentInjector ? noop : this.failInit;
        this.compInjector = componentInjector;
        if (options.trackOutputChanges) {
            /** @type {?} */
            const outputsDiffer = this.differs.find({}).create();
            this.outputsChanged = (/**
             * @param {?} outputs
             * @return {?}
             */
            outputs => !!outputsDiffer.diff(outputs));
        }
    }
    /**
     * @param {?} inputs
     * @param {?} outputs
     * @param {?} inputsChanged
     * @param {?} outputsChanged
     * @return {?}
     */
    update(inputs, outputs, inputsChanged, outputsChanged) {
        this.checkInit();
        this.updateIO(inputs, outputs);
        /** @type {?} */
        const compChanged = this.componentInstChanged;
        if (compChanged || inputsChanged) {
            /** @type {?} */
            const inputsChanges = this._getInputsChanges();
            if (inputsChanges) {
                this._updateInputChanges(inputsChanges);
            }
            this.updateInputs(compChanged || !this.lastInputChanges);
        }
        if (compChanged || outputsChanged) {
            this.bindOutputs();
        }
    }
    /**
     * @return {?}
     */
    maybeUpdate() {
        this.checkInit();
        if (this.componentInstChanged) {
            this.updateInputs(true);
            this.bindOutputs();
            return;
        }
        if (this.outputsChanged(this.outputs)) {
            this.bindOutputs();
        }
        if (!this.inputs) {
            return;
        }
        /** @type {?} */
        const inputsChanges = this._getInputsChanges();
        if (inputsChanges) {
            /** @type {?} */
            const isNotFirstChange = !!this.lastInputChanges;
            this._updateInputChanges(inputsChanges);
            if (isNotFirstChange) {
                this.updateInputs();
            }
        }
    }
    /**
     * @private
     * @param {?} inputs
     * @param {?} outputs
     * @return {?}
     */
    updateIO(inputs, outputs) {
        this.inputs = inputs;
        this.outputs = outputs;
    }
    /**
     * @private
     * @param {?=} isFirstChange
     * @return {?}
     */
    updateInputs(isFirstChange = false) {
        if (isFirstChange) {
            this._updateCompFactory();
        }
        /** @type {?} */
        const compInst = this.componentInst;
        /** @type {?} */
        let inputs = this.inputs;
        if (!inputs || !compInst) {
            return;
        }
        inputs = this._resolveInputs(inputs);
        Object.keys(inputs).forEach((/**
         * @param {?} p
         * @return {?}
         */
        p => (compInst[p] = inputs[p])));
        // Mark component for check to re-render with new inputs
        if (this.compCdr) {
            this.compCdr.markForCheck();
        }
        this.notifyOnInputChanges(this.lastInputChanges, isFirstChange);
    }
    /**
     * @private
     * @return {?}
     */
    bindOutputs() {
        this._disconnectOutputs();
        /** @type {?} */
        const compInst = this.componentInst;
        /** @type {?} */
        let outputs = this.outputs;
        if (!outputs || !compInst) {
            return;
        }
        outputs = this._resolveOutputs(outputs);
        Object.keys(outputs)
            .filter((/**
         * @param {?} p
         * @return {?}
         */
        p => compInst[p]))
            .forEach((/**
         * @param {?} p
         * @return {?}
         */
        p => compInst[p]
            .pipe(takeUntil(this.outputsShouldDisconnect$))
            .subscribe((/**
         * @param {?} event
         * @return {?}
         */
        (event) => ((/** @type {?} */ (outputs[p])))(event)))));
    }
    /**
     * @private
     * @param {?=} changes
     * @param {?=} forceFirstChanges
     * @return {?}
     */
    notifyOnInputChanges(changes = {}, forceFirstChanges) {
        // Exit early if component not interested to receive changes
        if (!this.componentInst.ngOnChanges) {
            return;
        }
        if (forceFirstChanges) {
            changes = this._collectFirstChanges();
        }
        this.componentInst.ngOnChanges(changes);
    }
    /**
     * @private
     * @return {?}
     */
    _disconnectOutputs() {
        this.outputsShouldDisconnect$.next();
    }
    /**
     * @private
     * @return {?}
     */
    _getInputsChanges() {
        return this.inputsDiffer.diff(this.inputs);
    }
    /**
     * @private
     * @param {?} differ
     * @return {?}
     */
    _updateInputChanges(differ) {
        this.lastInputChanges = this._collectChangesFromDiffer(differ);
    }
    /**
     * @private
     * @return {?}
     */
    _collectFirstChanges() {
        /** @type {?} */
        const changes = (/** @type {?} */ ({}));
        /** @type {?} */
        const inputs = this.inputs;
        Object.keys(inputs).forEach((/**
         * @param {?} prop
         * @return {?}
         */
        prop => (changes[prop] = createNewChange(inputs[prop]))));
        return this._resolveChanges(changes);
    }
    /**
     * @private
     * @param {?} differ
     * @return {?}
     */
    _collectChangesFromDiffer(differ) {
        /** @type {?} */
        const changes = {};
        differ.forEachAddedItem((/**
         * @param {?} record
         * @return {?}
         */
        record => (changes[record.key] = createNewChange(record.currentValue))));
        differ.forEachChangedItem((/**
         * @param {?} record
         * @return {?}
         */
        record => (changes[record.key] = createChange(record.currentValue, record.previousValue))));
        return this._resolveChanges(changes);
    }
    /**
     * @private
     * @return {?}
     */
    _resolveCompFactory() {
        try {
            try {
                return this.cfr.resolveComponentFactory(this.compRef.componentType);
            }
            catch (e) {
                // Fallback if componentType does not exist (happens on NgComponentOutlet)
                return this.cfr.resolveComponentFactory(this.compRef.instance.constructor);
            }
        }
        catch (e) {
            // Factory not available - bailout
            return null;
        }
    }
    /**
     * @private
     * @return {?}
     */
    _updateCompFactory() {
        this.compFactory = this._resolveCompFactory();
    }
    /**
     * @private
     * @param {?} inputs
     * @return {?}
     */
    _resolveInputs(inputs) {
        if (!this.compFactory) {
            return inputs;
        }
        return this._remapIO(inputs, this.compFactory.inputs);
    }
    /**
     * @private
     * @param {?} outputs
     * @return {?}
     */
    _resolveOutputs(outputs) {
        outputs = this._processOutputs(outputs);
        if (!this.compFactory) {
            return outputs;
        }
        return this._remapIO(outputs, this.compFactory.outputs);
    }
    /**
     * @private
     * @param {?} outputs
     * @return {?}
     */
    _processOutputs(outputs) {
        /** @type {?} */
        const processedOutputs = {};
        Object.keys(outputs).forEach((/**
         * @param {?} key
         * @return {?}
         */
        key => {
            /** @type {?} */
            const outputExpr = outputs[key];
            if (typeof outputExpr === 'function') {
                processedOutputs[key] = outputExpr;
            }
            else {
                processedOutputs[key] =
                    outputExpr && this._processOutputArgs(outputExpr);
            }
        }));
        return processedOutputs;
    }
    /**
     * @private
     * @param {?} output
     * @return {?}
     */
    _processOutputArgs(output) {
        const { handler } = output;
        /** @type {?} */
        const args = 'args' in output ? output.args || [] : [this.eventArgument];
        return (/**
         * @param {?} event
         * @return {?}
         */
        event => handler(...args.map((/**
         * @param {?} arg
         * @return {?}
         */
        arg => (arg === this.eventArgument ? event : arg)))));
    }
    /**
     * @private
     * @param {?} changes
     * @return {?}
     */
    _resolveChanges(changes) {
        if (!this.compFactory) {
            return changes;
        }
        return this._remapIO(changes, this.compFactory.inputs);
    }
    /**
     * @private
     * @template T
     * @param {?} io
     * @param {?} mapping
     * @return {?}
     */
    _remapIO(io, mapping) {
        /** @type {?} */
        const newIO = {};
        Object.keys(io).forEach((/**
         * @param {?} key
         * @return {?}
         */
        key => {
            /** @type {?} */
            const newKey = this._findPropByTplInMapping(key, mapping) || key;
            newIO[newKey] = io[key];
        }));
        return (/** @type {?} */ (newIO));
    }
    /**
     * @private
     * @param {?} tplName
     * @param {?} mapping
     * @return {?}
     */
    _findPropByTplInMapping(tplName, mapping) {
        for (const map of mapping) {
            if (map.templateName === tplName) {
                return map.propName;
            }
        }
        return null;
    }
    /**
     * @private
     * @return {?}
     */
    failInit() {
        throw Error('IoService: ComponentInjector was not set! Please call init() method!');
    }
}
IoService.decorators = [
    { type: Injectable }
];
/** @nocollapse */
IoService.ctorParameters = () => [
    { type: KeyValueDiffers },
    { type: ComponentFactoryResolver },
    { type: String, decorators: [{ type: Inject, args: [EventArgumentToken,] }] }
];
if (false) {
    /**
     * @type {?}
     * @private
     */
    IoService.prototype.checkInit;
    /**
     * @type {?}
     * @private
     */
    IoService.prototype.lastComponentInst;
    /**
     * @type {?}
     * @private
     */
    IoService.prototype.lastInputChanges;
    /**
     * @type {?}
     * @private
     */
    IoService.prototype.inputsDiffer;
    /**
     * @type {?}
     * @private
     */
    IoService.prototype.compFactory;
    /**
     * @type {?}
     * @private
     */
    IoService.prototype.outputsShouldDisconnect$;
    /**
     * @type {?}
     * @private
     */
    IoService.prototype.inputs;
    /**
     * @type {?}
     * @private
     */
    IoService.prototype.outputs;
    /**
     * @type {?}
     * @private
     */
    IoService.prototype.compInjector;
    /**
     * @type {?}
     * @private
     */
    IoService.prototype.outputsChanged;
    /**
     * @type {?}
     * @private
     */
    IoService.prototype.differs;
    /**
     * @type {?}
     * @private
     */
    IoService.prototype.cfr;
    /**
     * @type {?}
     * @private
     */
    IoService.prototype.eventArgument;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW8uc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLi8uLi8uLi9wcm9qZWN0cy9uZy1keW5hbWljLWNvbXBvbmVudC9zcmMvIiwic291cmNlcyI6WyJsaWIvaW8vaW8uc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUFBLE9BQU8sRUFDTCxpQkFBaUIsRUFFakIsd0JBQXdCLEVBQ3hCLE1BQU0sRUFDTixVQUFVLEVBRVYsZUFBZSxHQUdoQixNQUFNLGVBQWUsQ0FBQztBQUN2QixPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQy9CLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUczQyxPQUFPLEVBQUUsWUFBWSxFQUFFLGVBQWUsRUFBRSxJQUFJLEVBQUUsTUFBTSxTQUFTLENBQUM7QUFDOUQsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sa0JBQWtCLENBQUM7Ozs7QUFHdEQsK0JBR0M7OztJQUZDLDZCQUFpQjs7SUFDakIsaUNBQXFCOzs7OztBQUt2QixtQ0FFQzs7O0lBREMsMkNBQTZCOzs7OztBQUcvQixtQ0FFQztBQUdELE1BQU0sT0FBTyxTQUFTOzs7Ozs7SUFvQ3BCLFlBQ1UsT0FBd0IsRUFDeEIsR0FBNkIsRUFFN0IsYUFBcUI7UUFIckIsWUFBTyxHQUFQLE9BQU8sQ0FBaUI7UUFDeEIsUUFBRyxHQUFILEdBQUcsQ0FBMEI7UUFFN0Isa0JBQWEsR0FBYixhQUFhLENBQVE7UUF2Q3ZCLGNBQVMsR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDO1FBRTFCLHNCQUFpQixHQUFRLElBQUksQ0FBQztRQUU5QixpQkFBWSxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDLE1BQU0sRUFBRSxDQUFDO1FBQzlDLGdCQUFXLEdBQWlDLElBQUksQ0FBQztRQUNqRCw2QkFBd0IsR0FBRyxJQUFJLE9BQU8sRUFBUSxDQUFDO1FBSy9DLG1CQUFjOzs7UUFB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QU0sQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUMsT0FBTzs7OztRQUFDLEdBQUcsQ0FBQyxFQUFFOztrQkFDdEIsTUFBTSxHQUFHLElBQUksQ0FBQyx1QkFBdUIsQ0FBQyxHQUFHLEVBQUUsT0FBTyxDQUFDLElBQUksR0FBRztZQUNoRSxLQUFLLENBQUMsTUFBTSxDQUFDLEdBQUcsRUFBRSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQzFCLENBQUMsRUFBQyxDQUFDO1FBRUgsT0FBTyxtQkFBQSxLQUFLLEVBQUssQ0FBQztJQUNwQixDQUFDOzs7Ozs7O0lBRU8sdUJBQXVCLENBQzdCLE9BQWUsRUFDZixPQUFzQjtRQUV0QixLQUFLLE1BQU0sR0FBRyxJQUFJLE9BQU8sRUFBRTtZQUN6QixJQUFJLEdBQUcsQ0FBQyxZQUFZLEtBQUssT0FBTyxFQUFFO2dCQUNoQyxPQUFPLEdBQUcsQ0FBQyxRQUFRLENBQUM7YUFDckI7U0FDRjtRQUNELE9BQU8sSUFBSSxDQUFDO0lBQ2QsQ0FBQzs7Ozs7SUFFTyxRQUFRO1FBQ2QsTUFBTSxLQUFLLENBQ1Qsc0VBQXNFLENBQ3ZFLENBQUM7SUFDSixDQUFDOzs7WUFsVUYsVUFBVTs7OztZQTNCVCxlQUFlO1lBSmYsd0JBQXdCO3lDQXVFckIsTUFBTSxTQUFDLGtCQUFrQjs7Ozs7OztJQXRDNUIsOEJBQWtDOzs7OztJQUVsQyxzQ0FBc0M7Ozs7O0lBQ3RDLHFDQUF3Qzs7Ozs7SUFDeEMsaUNBQXNEOzs7OztJQUN0RCxnQ0FBeUQ7Ozs7O0lBQ3pELDZDQUF1RDs7Ozs7SUFFdkQsMkJBQTJCOzs7OztJQUMzQiw0QkFBNkI7Ozs7O0lBQzdCLGlDQUErQzs7Ozs7SUFDL0MsbUNBQXdFOzs7OztJQXlCdEUsNEJBQWdDOzs7OztJQUNoQyx3QkFBcUM7Ozs7O0lBQ3JDLGtDQUM2QiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIENoYW5nZURldGVjdG9yUmVmLFxuICBDb21wb25lbnRGYWN0b3J5LFxuICBDb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIsXG4gIEluamVjdCxcbiAgSW5qZWN0YWJsZSxcbiAgS2V5VmFsdWVDaGFuZ2VzLFxuICBLZXlWYWx1ZURpZmZlcnMsXG4gIE9uRGVzdHJveSxcbiAgU2ltcGxlQ2hhbmdlcyxcbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBTdWJqZWN0IH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyB0YWtlVW50aWwgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5cbmltcG9ydCB7IER5bmFtaWNDb21wb25lbnRJbmplY3RvciB9IGZyb20gJy4uL2NvbXBvbmVudC1pbmplY3Rvci90b2tlbic7XG5pbXBvcnQgeyBjcmVhdGVDaGFuZ2UsIGNyZWF0ZU5ld0NoYW5nZSwgbm9vcCB9IGZyb20gJy4uL3V0aWwnO1xuaW1wb3J0IHsgRXZlbnRBcmd1bWVudFRva2VuIH0gZnJvbSAnLi9ldmVudC1hcmd1bWVudCc7XG5pbXBvcnQgeyBFdmVudEhhbmRsZXIsIElucHV0c1R5cGUsIE91dHB1dHNUeXBlLCBPdXRwdXRXaXRoQXJncyB9IGZyb20gJy4vdHlwZXMnO1xuXG5leHBvcnQgaW50ZXJmYWNlIElPTWFwSW5mbyB7XG4gIHByb3BOYW1lOiBzdHJpbmc7XG4gIHRlbXBsYXRlTmFtZTogc3RyaW5nO1xufVxuZXhwb3J0IHR5cGUgSU9NYXBwaW5nTGlzdCA9IElPTWFwSW5mb1tdO1xuZXhwb3J0IHR5cGUgS2V5VmFsdWVDaGFuZ2VzQW55ID0gS2V5VmFsdWVDaGFuZ2VzPGFueSwgYW55PjtcblxuZXhwb3J0IGludGVyZmFjZSBJb0luaXRPcHRpb25zIHtcbiAgdHJhY2tPdXRwdXRDaGFuZ2VzPzogYm9vbGVhbjtcbn1cblxuaW50ZXJmYWNlIE91dHB1dHNUeXBlUHJvY2Vzc2VkIGV4dGVuZHMgT3V0cHV0c1R5cGUge1xuICBbazogc3RyaW5nXTogRXZlbnRIYW5kbGVyO1xufVxuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgSW9TZXJ2aWNlIGltcGxlbWVudHMgT25EZXN0cm95IHtcbiAgcHJpdmF0ZSBjaGVja0luaXQgPSB0aGlzLmZhaWxJbml0O1xuXG4gIHByaXZhdGUgbGFzdENvbXBvbmVudEluc3Q6IGFueSA9IG51bGw7XG4gIHByaXZhdGUgbGFzdElucHV0Q2hhbmdlczogU2ltcGxlQ2hhbmdlcztcbiAgcHJpdmF0ZSBpbnB1dHNEaWZmZXIgPSB0aGlzLmRpZmZlcnMuZmluZCh7fSkuY3JlYXRlKCk7XG4gIHByaXZhdGUgY29tcEZhY3Rvcnk6IENvbXBvbmVudEZhY3Rvcnk8YW55PiB8IG51bGwgPSBudWxsO1xuICBwcml2YXRlIG91dHB1dHNTaG91bGREaXNjb25uZWN0JCA9IG5ldyBTdWJqZWN0PHZvaWQ+KCk7XG5cbiAgcHJpdmF0ZSBpbnB1dHM6IElucHV0c1R5cGU7XG4gIHByaXZhdGUgb3V0cHV0czogT3V0cHV0c1R5cGU7XG4gIHByaXZhdGUgY29tcEluamVjdG9yOiBEeW5hbWljQ29tcG9uZW50SW5qZWN0b3I7XG4gIHByaXZhdGUgb3V0cHV0c0NoYW5nZWQ6IChvdXRwdXRzOiBPdXRwdXRzVHlwZSkgPT4gYm9vbGVhbiA9ICgpID0+IGZhbHNlO1xuXG4gIHByaXZhdGUgZ2V0IGNvbXBSZWYoKSB7XG4gICAgcmV0dXJuIHRoaXMuY29tcEluamVjdG9yLmNvbXBvbmVudFJlZjtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0IGNvbXBvbmVudEluc3QoKSB7XG4gICAgcmV0dXJuIHRoaXMuY29tcFJlZiA/IHRoaXMuY29tcFJlZi5pbnN0YW5jZSA6IG51bGw7XG4gIH1cblxuICBwcml2YXRlIGdldCBjb21wb25lbnRJbnN0Q2hhbmdlZCgpOiBib29sZWFuIHtcbiAgICBpZiAodGhpcy5sYXN0Q29tcG9uZW50SW5zdCAhPT0gdGhpcy5jb21wb25lbnRJbnN0KSB7XG4gICAgICB0aGlzLmxhc3RDb21wb25lbnRJbnN0ID0gdGhpcy5jb21wb25lbnRJbnN0O1xuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGdldCBjb21wQ2RyKCk6IENoYW5nZURldGVjdG9yUmVmIHtcbiAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6IGRlcHJlY2F0aW9uXG4gICAgcmV0dXJuIHRoaXMuY29tcFJlZiA/IHRoaXMuY29tcFJlZi5pbmplY3Rvci5nZXQoQ2hhbmdlRGV0ZWN0b3JSZWYpIDogbnVsbDtcbiAgfVxuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgZGlmZmVyczogS2V5VmFsdWVEaWZmZXJzLFxuICAgIHByaXZhdGUgY2ZyOiBDb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIsXG4gICAgQEluamVjdChFdmVudEFyZ3VtZW50VG9rZW4pXG4gICAgcHJpdmF0ZSBldmVudEFyZ3VtZW50OiBzdHJpbmcsXG4gICkge31cblxuICBuZ09uRGVzdHJveSgpOiB2b2lkIHtcbiAgICB0aGlzLl9kaXNjb25uZWN0T3V0cHV0cygpO1xuICB9XG5cbiAgaW5pdChcbiAgICBjb21wb25lbnRJbmplY3RvcjogRHluYW1pY0NvbXBvbmVudEluamVjdG9yLFxuICAgIG9wdGlvbnM6IElvSW5pdE9wdGlvbnMgPSB7fSxcbiAgKSB7XG4gICAgdGhpcy5jaGVja0luaXQgPSBjb21wb25lbnRJbmplY3RvciA/IG5vb3AgOiB0aGlzLmZhaWxJbml0O1xuICAgIHRoaXMuY29tcEluamVjdG9yID0gY29tcG9uZW50SW5qZWN0b3I7XG5cbiAgICBpZiAob3B0aW9ucy50cmFja091dHB1dENoYW5nZXMpIHtcbiAgICAgIGNvbnN0IG91dHB1dHNEaWZmZXIgPSB0aGlzLmRpZmZlcnMuZmluZCh7fSkuY3JlYXRlKCk7XG4gICAgICB0aGlzLm91dHB1dHNDaGFuZ2VkID0gb3V0cHV0cyA9PiAhIW91dHB1dHNEaWZmZXIuZGlmZihvdXRwdXRzKTtcbiAgICB9XG4gIH1cblxuICB1cGRhdGUoXG4gICAgaW5wdXRzOiBJbnB1dHNUeXBlLFxuICAgIG91dHB1dHM6IE91dHB1dHNUeXBlLFxuICAgIGlucHV0c0NoYW5nZWQ6IGJvb2xlYW4sXG4gICAgb3V0cHV0c0NoYW5nZWQ6IGJvb2xlYW4sXG4gICkge1xuICAgIHRoaXMuY2hlY2tJbml0KCk7XG4gICAgdGhpcy51cGRhdGVJTyhpbnB1dHMsIG91dHB1dHMpO1xuXG4gICAgY29uc3QgY29tcENoYW5nZWQgPSB0aGlzLmNvbXBvbmVudEluc3RDaGFuZ2VkO1xuXG4gICAgaWYgKGNvbXBDaGFuZ2VkIHx8IGlucHV0c0NoYW5nZWQpIHtcbiAgICAgIGNvbnN0IGlucHV0c0NoYW5nZXMgPSB0aGlzLl9nZXRJbnB1dHNDaGFuZ2VzKCk7XG4gICAgICBpZiAoaW5wdXRzQ2hhbmdlcykge1xuICAgICAgICB0aGlzLl91cGRhdGVJbnB1dENoYW5nZXMoaW5wdXRzQ2hhbmdlcyk7XG4gICAgICB9XG4gICAgICB0aGlzLnVwZGF0ZUlucHV0cyhjb21wQ2hhbmdlZCB8fCAhdGhpcy5sYXN0SW5wdXRDaGFuZ2VzKTtcbiAgICB9XG5cbiAgICBpZiAoY29tcENoYW5nZWQgfHwgb3V0cHV0c0NoYW5nZWQpIHtcbiAgICAgIHRoaXMuYmluZE91dHB1dHMoKTtcbiAgICB9XG4gIH1cblxuICBtYXliZVVwZGF0ZSgpIHtcbiAgICB0aGlzLmNoZWNrSW5pdCgpO1xuXG4gICAgaWYgKHRoaXMuY29tcG9uZW50SW5zdENoYW5nZWQpIHtcbiAgICAgIHRoaXMudXBkYXRlSW5wdXRzKHRydWUpO1xuICAgICAgdGhpcy5iaW5kT3V0cHV0cygpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGlmICh0aGlzLm91dHB1dHNDaGFuZ2VkKHRoaXMub3V0cHV0cykpIHtcbiAgICAgIHRoaXMuYmluZE91dHB1dHMoKTtcbiAgICB9XG5cbiAgICBpZiAoIXRoaXMuaW5wdXRzKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgY29uc3QgaW5wdXRzQ2hhbmdlcyA9IHRoaXMuX2dldElucHV0c0NoYW5nZXMoKTtcblxuICAgIGlmIChpbnB1dHNDaGFuZ2VzKSB7XG4gICAgICBjb25zdCBpc05vdEZpcnN0Q2hhbmdlID0gISF0aGlzLmxhc3RJbnB1dENoYW5nZXM7XG4gICAgICB0aGlzLl91cGRhdGVJbnB1dENoYW5nZXMoaW5wdXRzQ2hhbmdlcyk7XG5cbiAgICAgIGlmIChpc05vdEZpcnN0Q2hhbmdlKSB7XG4gICAgICAgIHRoaXMudXBkYXRlSW5wdXRzKCk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSB1cGRhdGVJTyhpbnB1dHM6IElucHV0c1R5cGUsIG91dHB1dHM6IE91dHB1dHNUeXBlKSB7XG4gICAgdGhpcy5pbnB1dHMgPSBpbnB1dHM7XG4gICAgdGhpcy5vdXRwdXRzID0gb3V0cHV0cztcbiAgfVxuXG4gIHByaXZhdGUgdXBkYXRlSW5wdXRzKGlzRmlyc3RDaGFuZ2UgPSBmYWxzZSkge1xuICAgIGlmIChpc0ZpcnN0Q2hhbmdlKSB7XG4gICAgICB0aGlzLl91cGRhdGVDb21wRmFjdG9yeSgpO1xuICAgIH1cblxuICAgIGNvbnN0IGNvbXBJbnN0ID0gdGhpcy5jb21wb25lbnRJbnN0O1xuICAgIGxldCBpbnB1dHMgPSB0aGlzLmlucHV0cztcblxuICAgIGlmICghaW5wdXRzIHx8ICFjb21wSW5zdCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGlucHV0cyA9IHRoaXMuX3Jlc29sdmVJbnB1dHMoaW5wdXRzKTtcblxuICAgIE9iamVjdC5rZXlzKGlucHV0cykuZm9yRWFjaChwID0+IChjb21wSW5zdFtwXSA9IGlucHV0c1twXSkpO1xuXG4gICAgLy8gTWFyayBjb21wb25lbnQgZm9yIGNoZWNrIHRvIHJlLXJlbmRlciB3aXRoIG5ldyBpbnB1dHNcbiAgICBpZiAodGhpcy5jb21wQ2RyKSB7XG4gICAgICB0aGlzLmNvbXBDZHIubWFya0ZvckNoZWNrKCk7XG4gICAgfVxuXG4gICAgdGhpcy5ub3RpZnlPbklucHV0Q2hhbmdlcyh0aGlzLmxhc3RJbnB1dENoYW5nZXMsIGlzRmlyc3RDaGFuZ2UpO1xuICB9XG5cbiAgcHJpdmF0ZSBiaW5kT3V0cHV0cygpIHtcbiAgICB0aGlzLl9kaXNjb25uZWN0T3V0cHV0cygpO1xuXG4gICAgY29uc3QgY29tcEluc3QgPSB0aGlzLmNvbXBvbmVudEluc3Q7XG4gICAgbGV0IG91dHB1dHMgPSB0aGlzLm91dHB1dHM7XG5cbiAgICBpZiAoIW91dHB1dHMgfHwgIWNvbXBJbnN0KSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgb3V0cHV0cyA9IHRoaXMuX3Jlc29sdmVPdXRwdXRzKG91dHB1dHMpO1xuXG4gICAgT2JqZWN0LmtleXMob3V0cHV0cylcbiAgICAgIC5maWx0ZXIocCA9PiBjb21wSW5zdFtwXSlcbiAgICAgIC5mb3JFYWNoKHAgPT5cbiAgICAgICAgY29tcEluc3RbcF1cbiAgICAgICAgICAucGlwZSh0YWtlVW50aWwodGhpcy5vdXRwdXRzU2hvdWxkRGlzY29ubmVjdCQpKVxuICAgICAgICAgIC5zdWJzY3JpYmUoKGV2ZW50OiBhbnkpID0+IChvdXRwdXRzW3BdIGFzIEV2ZW50SGFuZGxlcikoZXZlbnQpKSxcbiAgICAgICk7XG4gIH1cblxuICBwcml2YXRlIG5vdGlmeU9uSW5wdXRDaGFuZ2VzKFxuICAgIGNoYW5nZXM6IFNpbXBsZUNoYW5nZXMgPSB7fSxcbiAgICBmb3JjZUZpcnN0Q2hhbmdlczogYm9vbGVhbixcbiAgKSB7XG4gICAgLy8gRXhpdCBlYXJseSBpZiBjb21wb25lbnQgbm90IGludGVyZXN0ZWQgdG8gcmVjZWl2ZSBjaGFuZ2VzXG4gICAgaWYgKCF0aGlzLmNvbXBvbmVudEluc3QubmdPbkNoYW5nZXMpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBpZiAoZm9yY2VGaXJzdENoYW5nZXMpIHtcbiAgICAgIGNoYW5nZXMgPSB0aGlzLl9jb2xsZWN0Rmlyc3RDaGFuZ2VzKCk7XG4gICAgfVxuXG4gICAgdGhpcy5jb21wb25lbnRJbnN0Lm5nT25DaGFuZ2VzKGNoYW5nZXMpO1xuICB9XG5cbiAgcHJpdmF0ZSBfZGlzY29ubmVjdE91dHB1dHMoKSB7XG4gICAgdGhpcy5vdXRwdXRzU2hvdWxkRGlzY29ubmVjdCQubmV4dCgpO1xuICB9XG5cbiAgcHJpdmF0ZSBfZ2V0SW5wdXRzQ2hhbmdlcygpOiBLZXlWYWx1ZUNoYW5nZXNBbnkge1xuICAgIHJldHVybiB0aGlzLmlucHV0c0RpZmZlci5kaWZmKHRoaXMuaW5wdXRzKTtcbiAgfVxuXG4gIHByaXZhdGUgX3VwZGF0ZUlucHV0Q2hhbmdlcyhkaWZmZXI6IEtleVZhbHVlQ2hhbmdlc0FueSkge1xuICAgIHRoaXMubGFzdElucHV0Q2hhbmdlcyA9IHRoaXMuX2NvbGxlY3RDaGFuZ2VzRnJvbURpZmZlcihkaWZmZXIpO1xuICB9XG5cbiAgcHJpdmF0ZSBfY29sbGVjdEZpcnN0Q2hhbmdlcygpOiBTaW1wbGVDaGFuZ2VzIHtcbiAgICBjb25zdCBjaGFuZ2VzID0ge30gYXMgU2ltcGxlQ2hhbmdlcztcbiAgICBjb25zdCBpbnB1dHMgPSB0aGlzLmlucHV0cztcblxuICAgIE9iamVjdC5rZXlzKGlucHV0cykuZm9yRWFjaChcbiAgICAgIHByb3AgPT4gKGNoYW5nZXNbcHJvcF0gPSBjcmVhdGVOZXdDaGFuZ2UoaW5wdXRzW3Byb3BdKSksXG4gICAgKTtcblxuICAgIHJldHVybiB0aGlzLl9yZXNvbHZlQ2hhbmdlcyhjaGFuZ2VzKTtcbiAgfVxuXG4gIHByaXZhdGUgX2NvbGxlY3RDaGFuZ2VzRnJvbURpZmZlcihkaWZmZXI6IEtleVZhbHVlQ2hhbmdlc0FueSk6IFNpbXBsZUNoYW5nZXMge1xuICAgIGNvbnN0IGNoYW5nZXM6IFNpbXBsZUNoYW5nZXMgPSB7fTtcblxuICAgIGRpZmZlci5mb3JFYWNoQWRkZWRJdGVtKFxuICAgICAgcmVjb3JkID0+IChjaGFuZ2VzW3JlY29yZC5rZXldID0gY3JlYXRlTmV3Q2hhbmdlKHJlY29yZC5jdXJyZW50VmFsdWUpKSxcbiAgICApO1xuXG4gICAgZGlmZmVyLmZvckVhY2hDaGFuZ2VkSXRlbShcbiAgICAgIHJlY29yZCA9PlxuICAgICAgICAoY2hhbmdlc1tyZWNvcmQua2V5XSA9IGNyZWF0ZUNoYW5nZShcbiAgICAgICAgICByZWNvcmQuY3VycmVudFZhbHVlLFxuICAgICAgICAgIHJlY29yZC5wcmV2aW91c1ZhbHVlLFxuICAgICAgICApKSxcbiAgICApO1xuXG4gICAgcmV0dXJuIHRoaXMuX3Jlc29sdmVDaGFuZ2VzKGNoYW5nZXMpO1xuICB9XG5cbiAgcHJpdmF0ZSBfcmVzb2x2ZUNvbXBGYWN0b3J5KCk6IENvbXBvbmVudEZhY3Rvcnk8YW55PiB8IG51bGwge1xuICAgIHRyeSB7XG4gICAgICB0cnkge1xuICAgICAgICByZXR1cm4gdGhpcy5jZnIucmVzb2x2ZUNvbXBvbmVudEZhY3RvcnkodGhpcy5jb21wUmVmLmNvbXBvbmVudFR5cGUpO1xuICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAvLyBGYWxsYmFjayBpZiBjb21wb25lbnRUeXBlIGRvZXMgbm90IGV4aXN0IChoYXBwZW5zIG9uIE5nQ29tcG9uZW50T3V0bGV0KVxuICAgICAgICByZXR1cm4gdGhpcy5jZnIucmVzb2x2ZUNvbXBvbmVudEZhY3RvcnkoXG4gICAgICAgICAgdGhpcy5jb21wUmVmLmluc3RhbmNlLmNvbnN0cnVjdG9yLFxuICAgICAgICApO1xuICAgICAgfVxuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIC8vIEZhY3Rvcnkgbm90IGF2YWlsYWJsZSAtIGJhaWxvdXRcbiAgICAgIHJldHVybiBudWxsO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgX3VwZGF0ZUNvbXBGYWN0b3J5KCkge1xuICAgIHRoaXMuY29tcEZhY3RvcnkgPSB0aGlzLl9yZXNvbHZlQ29tcEZhY3RvcnkoKTtcbiAgfVxuXG4gIHByaXZhdGUgX3Jlc29sdmVJbnB1dHMoaW5wdXRzOiBJbnB1dHNUeXBlKTogSW5wdXRzVHlwZSB7XG4gICAgaWYgKCF0aGlzLmNvbXBGYWN0b3J5KSB7XG4gICAgICByZXR1cm4gaW5wdXRzO1xuICAgIH1cblxuICAgIHJldHVybiB0aGlzLl9yZW1hcElPKGlucHV0cywgdGhpcy5jb21wRmFjdG9yeS5pbnB1dHMpO1xuICB9XG5cbiAgcHJpdmF0ZSBfcmVzb2x2ZU91dHB1dHMob3V0cHV0czogT3V0cHV0c1R5cGUpOiBPdXRwdXRzVHlwZSB7XG4gICAgb3V0cHV0cyA9IHRoaXMuX3Byb2Nlc3NPdXRwdXRzKG91dHB1dHMpO1xuXG4gICAgaWYgKCF0aGlzLmNvbXBGYWN0b3J5KSB7XG4gICAgICByZXR1cm4gb3V0cHV0cztcbiAgICB9XG5cbiAgICByZXR1cm4gdGhpcy5fcmVtYXBJTyhvdXRwdXRzLCB0aGlzLmNvbXBGYWN0b3J5Lm91dHB1dHMpO1xuICB9XG5cbiAgcHJpdmF0ZSBfcHJvY2Vzc091dHB1dHMob3V0cHV0czogT3V0cHV0c1R5cGUpOiBPdXRwdXRzVHlwZVByb2Nlc3NlZCB7XG4gICAgY29uc3QgcHJvY2Vzc2VkT3V0cHV0czogT3V0cHV0c1R5cGVQcm9jZXNzZWQgPSB7fTtcblxuICAgIE9iamVjdC5rZXlzKG91dHB1dHMpLmZvckVhY2goa2V5ID0+IHtcbiAgICAgIGNvbnN0IG91dHB1dEV4cHIgPSBvdXRwdXRzW2tleV07XG5cbiAgICAgIGlmICh0eXBlb2Ygb3V0cHV0RXhwciA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgICBwcm9jZXNzZWRPdXRwdXRzW2tleV0gPSBvdXRwdXRFeHByO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcHJvY2Vzc2VkT3V0cHV0c1trZXldID1cbiAgICAgICAgICBvdXRwdXRFeHByICYmIHRoaXMuX3Byb2Nlc3NPdXRwdXRBcmdzKG91dHB1dEV4cHIpO1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgcmV0dXJuIHByb2Nlc3NlZE91dHB1dHM7XG4gIH1cblxuICBwcml2YXRlIF9wcm9jZXNzT3V0cHV0QXJncyhvdXRwdXQ6IE91dHB1dFdpdGhBcmdzKTogRXZlbnRIYW5kbGVyIHtcbiAgICBjb25zdCB7IGhhbmRsZXIgfSA9IG91dHB1dDtcbiAgICBjb25zdCBhcmdzID0gJ2FyZ3MnIGluIG91dHB1dCA/IG91dHB1dC5hcmdzIHx8IFtdIDogW3RoaXMuZXZlbnRBcmd1bWVudF07XG5cbiAgICByZXR1cm4gZXZlbnQgPT5cbiAgICAgIGhhbmRsZXIoLi4uYXJncy5tYXAoYXJnID0+IChhcmcgPT09IHRoaXMuZXZlbnRBcmd1bWVudCA/IGV2ZW50IDogYXJnKSkpO1xuICB9XG5cbiAgcHJpdmF0ZSBfcmVzb2x2ZUNoYW5nZXMoY2hhbmdlczogU2ltcGxlQ2hhbmdlcyk6IFNpbXBsZUNoYW5nZXMge1xuICAgIGlmICghdGhpcy5jb21wRmFjdG9yeSkge1xuICAgICAgcmV0dXJuIGNoYW5nZXM7XG4gICAgfVxuXG4gICAgcmV0dXJuIHRoaXMuX3JlbWFwSU8oY2hhbmdlcywgdGhpcy5jb21wRmFjdG9yeS5pbnB1dHMpO1xuICB9XG5cbiAgcHJpdmF0ZSBfcmVtYXBJTzxUIGV4dGVuZHMgUmVjb3JkPHN0cmluZywgYW55Pj4oXG4gICAgaW86IFQsXG4gICAgbWFwcGluZzogSU9NYXBwaW5nTGlzdCxcbiAgKTogVCB7XG4gICAgY29uc3QgbmV3SU8gPSB7fTtcblxuICAgIE9iamVjdC5rZXlzKGlvKS5mb3JFYWNoKGtleSA9PiB7XG4gICAgICBjb25zdCBuZXdLZXkgPSB0aGlzLl9maW5kUHJvcEJ5VHBsSW5NYXBwaW5nKGtleSwgbWFwcGluZykgfHwga2V5O1xuICAgICAgbmV3SU9bbmV3S2V5XSA9IGlvW2tleV07XG4gICAgfSk7XG5cbiAgICByZXR1cm4gbmV3SU8gYXMgVDtcbiAgfVxuXG4gIHByaXZhdGUgX2ZpbmRQcm9wQnlUcGxJbk1hcHBpbmcoXG4gICAgdHBsTmFtZTogc3RyaW5nLFxuICAgIG1hcHBpbmc6IElPTWFwcGluZ0xpc3QsXG4gICk6IHN0cmluZyB8IG51bGwge1xuICAgIGZvciAoY29uc3QgbWFwIG9mIG1hcHBpbmcpIHtcbiAgICAgIGlmIChtYXAudGVtcGxhdGVOYW1lID09PSB0cGxOYW1lKSB7XG4gICAgICAgIHJldHVybiBtYXAucHJvcE5hbWU7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiBudWxsO1xuICB9XG5cbiAgcHJpdmF0ZSBmYWlsSW5pdCgpIHtcbiAgICB0aHJvdyBFcnJvcihcbiAgICAgICdJb1NlcnZpY2U6IENvbXBvbmVudEluamVjdG9yIHdhcyBub3Qgc2V0ISBQbGVhc2UgY2FsbCBpbml0KCkgbWV0aG9kIScsXG4gICAgKTtcbiAgfVxufVxuIl19