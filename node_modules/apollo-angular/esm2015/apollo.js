import { Injectable, Optional, Inject, NgZone } from '@angular/core';
import { ApolloClient, } from '@apollo/client/core';
import { from } from 'rxjs';
import { QueryRef } from './query-ref';
import { APOLLO_OPTIONS, APOLLO_NAMED_OPTIONS, APOLLO_FLAGS } from './tokens';
import { fromPromise, wrapWithZone, fixObservable, pickFlag } from './utils';
import * as i0 from "@angular/core";
import * as i1 from "./tokens";
import * as ɵngcc0 from '@angular/core';
export class ApolloBase {
    constructor(ngZone, flags, _client) {
        this.ngZone = ngZone;
        this.flags = flags;
        this._client = _client;
        this.useInitialLoading = pickFlag(flags, 'useInitialLoading', false);
    }
    watchQuery(options) {
        return new QueryRef(this.ensureClient().watchQuery(Object.assign({}, options)), this.ngZone, Object.assign({ useInitialLoading: this.useInitialLoading }, options));
    }
    query(options) {
        return fromPromise(() => this.ensureClient().query(Object.assign({}, options)));
    }
    mutate(options) {
        return fromPromise(() => this.ensureClient().mutate(Object.assign({}, options)));
    }
    subscribe(options, extra) {
        const obs = from(fixObservable(this.ensureClient().subscribe(Object.assign({}, options))));
        return extra && extra.useZone !== true
            ? obs
            : wrapWithZone(obs, this.ngZone);
    }
    /**
     * Get an access to an instance of ApolloClient
     * @deprecated use `apollo.client` instead
     */
    getClient() {
        return this.client;
    }
    /**
     * Set a new instance of ApolloClient
     * Remember to clean up the store before setting a new client.
     * @deprecated use `apollo.client = client` instead
     *
     * @param client ApolloClient instance
     */
    setClient(client) {
        this.client = client;
    }
    /**
     * Get an access to an instance of ApolloClient
     */
    get client() {
        return this._client;
    }
    /**
     * Set a new instance of ApolloClient
     * Remember to clean up the store before setting a new client.
     *
     * @param client ApolloClient instance
     */
    set client(client) {
        if (this._client) {
            throw new Error('Client has been already defined');
        }
        this._client = client;
    }
    ensureClient() {
        this.checkInstance();
        return this._client;
    }
    checkInstance() {
        if (!this._client) {
            throw new Error('Client has not been defined yet');
        }
    }
}
export class Apollo extends ApolloBase {
    constructor(_ngZone, apolloOptions, apolloNamedOptions, flags) {
        super(_ngZone, flags);
        this._ngZone = _ngZone;
        this.map = new Map();
        if (apolloOptions) {
            this.createDefault(apolloOptions);
        }
        if (apolloNamedOptions && typeof apolloNamedOptions === 'object') {
            for (let name in apolloNamedOptions) {
                if (apolloNamedOptions.hasOwnProperty(name)) {
                    const options = apolloNamedOptions[name];
                    this.createNamed(name, options);
                }
            }
        }
    }
    /**
     * Create an instance of ApolloClient
     * @param options Options required to create ApolloClient
     * @param name client's name
     */
    create(options, name) {
        if (isDefault(name)) {
            this.createDefault(options);
        }
        else {
            this.createNamed(name, options);
        }
    }
    /**
     * Use a default ApolloClient
     */
    default() {
        return this;
    }
    /**
     * Use a named ApolloClient
     * @param name client's name
     */
    use(name) {
        if (isDefault(name)) {
            return this.default();
        }
        return this.map.get(name);
    }
    /**
     * Create a default ApolloClient, same as `apollo.create(options)`
     * @param options ApolloClient's options
     */
    createDefault(options) {
        if (this.getClient()) {
            throw new Error('Apollo has been already created.');
        }
        return this.setClient(new ApolloClient(options));
    }
    /**
     * Create a named ApolloClient, same as `apollo.create(options, name)`
     * @param name client's name
     * @param options ApolloClient's options
     */
    createNamed(name, options) {
        if (this.map.has(name)) {
            throw new Error(`Client ${name} has been already created`);
        }
        this.map.set(name, new ApolloBase(this._ngZone, this.flags, new ApolloClient(options)));
    }
    /**
     * Remember to clean up the store before removing a client
     * @param name client's name
     */
    removeClient(name) {
        if (isDefault(name)) {
            this._client = undefined;
        }
        else {
            this.map.delete(name);
        }
    }
}
Apollo.ɵfac = function Apollo_Factory(t) { return new (t || Apollo)(ɵngcc0.ɵɵinject(ɵngcc0.NgZone), ɵngcc0.ɵɵinject(APOLLO_OPTIONS, 8), ɵngcc0.ɵɵinject(APOLLO_NAMED_OPTIONS, 8), ɵngcc0.ɵɵinject(APOLLO_FLAGS, 8)); };
Apollo.ɵprov = i0.ɵɵdefineInjectable({ factory: function Apollo_Factory() { return new Apollo(i0.ɵɵinject(i0.NgZone), i0.ɵɵinject(i1.APOLLO_OPTIONS, 8), i0.ɵɵinject(i1.APOLLO_NAMED_OPTIONS, 8), i0.ɵɵinject(i1.APOLLO_FLAGS, 8)); }, token: Apollo, providedIn: "root" });
Apollo.ctorParameters = () => [
    { type: NgZone },
    { type: undefined, decorators: [{ type: Optional }, { type: Inject, args: [APOLLO_OPTIONS,] }] },
    { type: undefined, decorators: [{ type: Optional }, { type: Inject, args: [APOLLO_NAMED_OPTIONS,] }] },
    { type: undefined, decorators: [{ type: Optional }, { type: Inject, args: [APOLLO_FLAGS,] }] }
];
(function () { (typeof ngDevMode === "undefined" || ngDevMode) && ɵngcc0.ɵsetClassMetadata(Apollo, [{
        type: Injectable,
        args: [{
                providedIn: 'root'
            }]
    }], function () { return [{ type: ɵngcc0.NgZone }, { type: undefined, decorators: [{
                type: Optional
            }, {
                type: Inject,
                args: [APOLLO_OPTIONS]
            }] }, { type: undefined, decorators: [{
                type: Optional
            }, {
                type: Inject,
                args: [APOLLO_NAMED_OPTIONS]
            }] }, { type: undefined, decorators: [{
                type: Optional
            }, {
                type: Inject,
                args: [APOLLO_FLAGS]
            }] }]; }, null); })();
function isDefault(name) {
    return !name || name === 'default';
}

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXBvbGxvLmpzIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi93b3Jrc3BhY2VzL2Fwb2xsby1hbmd1bGFyL3BhY2thZ2VzL2Fwb2xsby1hbmd1bGFyL3NyYy9hcG9sbG8udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFDLFVBQVUsRUFBRSxRQUFRLEVBQUUsTUFBTSxFQUFFLE1BQU0sRUFBQyxNQUFNLGVBQWUsQ0FBQztBQUNuRSxPQUFPLEVBQ0wsWUFBWSxHQVFiLE1BQU0scUJBQXFCLENBQUM7QUFDN0IsT0FBTyxFQUFhLElBQUksRUFBQyxNQUFNLE1BQU0sQ0FBQztBQUV0QyxPQUFPLEVBQUMsUUFBUSxFQUFDLE1BQU0sYUFBYSxDQUFDO0FBUXJDLE9BQU8sRUFBQyxjQUFjLEVBQUUsb0JBQW9CLEVBQUUsWUFBWSxFQUFDLE1BQU0sVUFBVSxDQUFDO0FBQzVFLE9BQU8sRUFBQyxXQUFXLEVBQUUsWUFBWSxFQUFFLGFBQWEsRUFBRSxRQUFRLEVBQUMsTUFBTSxTQUFTLENBQUM7QUFDM0U7QUFDb0M7O0FBQXBDLE1BQU0sT0FBTyxVQUFVO0FBQUcsSUFHeEIsWUFDWSxNQUFjLEVBQ2QsS0FBYSxFQUNiLE9BQW1DO0FBQy9DLFFBSFksV0FBTSxHQUFOLE1BQU0sQ0FBUTtBQUFDLFFBQ2YsVUFBSyxHQUFMLEtBQUssQ0FBUTtBQUFDLFFBQ2QsWUFBTyxHQUFQLE9BQU8sQ0FBNEI7QUFBQyxRQUU5QyxJQUFJLENBQUMsaUJBQWlCLEdBQUcsUUFBUSxDQUFDLEtBQUssRUFBRSxtQkFBbUIsRUFBRSxLQUFLLENBQUMsQ0FBQztBQUN6RSxJQUFFLENBQUM7QUFDSCxJQUNTLFVBQVUsQ0FDZixPQUE2QztBQUMvQyxRQUNFLE9BQU8sSUFBSSxRQUFRLENBQ2pCLElBQUksQ0FBQyxZQUFZLEVBQUUsQ0FBQyxVQUFVLG1CQUN6QixPQUFPLEVBQzRCLEVBQ3hDLElBQUksQ0FBQyxNQUFNLGtCQUVULGlCQUFpQixFQUFFLElBQUksQ0FBQyxp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QUNGLFFBQVEsWUFBSSxNQUFNLFNBQUMsWUFBWTtBQUFROzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7a0NBQUU7QUFxRzlDLFNBQVMsU0FBUyxDQUFDLElBQWE7QUFBSSxJQUNsQyxPQUFPLENBQUMsSUFBSSxJQUFJLElBQUksS0FBSyxTQUFTLENBQUM7QUFDckMsQ0FBQztBQUNEIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtJbmplY3RhYmxlLCBPcHRpb25hbCwgSW5qZWN0LCBOZ1pvbmV9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHtcbiAgQXBvbGxvQ2xpZW50LFxuICBRdWVyeU9wdGlvbnMsXG4gIE11dGF0aW9uT3B0aW9ucyxcbiAgQXBvbGxvUXVlcnlSZXN1bHQsXG4gIFN1YnNjcmlwdGlvbk9wdGlvbnMsXG4gIEFwb2xsb0NsaWVudE9wdGlvbnMsXG4gIE9ic2VydmFibGVRdWVyeSxcbiAgRmV0Y2hSZXN1bHQsXG59IGZyb20gJ0BhcG9sbG8vY2xpZW50L2NvcmUnO1xuaW1wb3J0IHtPYnNlcnZhYmxlLCBmcm9tfSBmcm9tICdyeGpzJztcblxuaW1wb3J0IHtRdWVyeVJlZn0gZnJvbSAnLi9xdWVyeS1yZWYnO1xuaW1wb3J0IHtcbiAgV2F0Y2hRdWVyeU9wdGlvbnMsXG4gIEV4dHJhU3Vic2NyaXB0aW9uT3B0aW9ucyxcbiAgRW1wdHlPYmplY3QsXG4gIE5hbWVkT3B0aW9ucyxcbiAgRmxhZ3MsXG59IGZyb20gJy4vdHlwZXMnO1xuaW1wb3J0IHtBUE9MTE9fT1BUSU9OUywgQVBPTExPX05BTUVEX09QVElPTlMsIEFQT0xMT19GTEFHU30gZnJvbSAnLi90b2tlbnMnO1xuaW1wb3J0IHtmcm9tUHJvbWlzZSwgd3JhcFdpdGhab25lLCBmaXhPYnNlcnZhYmxlLCBwaWNrRmxhZ30gZnJvbSAnLi91dGlscyc7XG5cbmV4cG9ydCBjbGFzcyBBcG9sbG9CYXNlPFRDYWNoZVNoYXBlID0gYW55PiB7XG4gIHByaXZhdGUgdXNlSW5pdGlhbExvYWRpbmc6IGJvb2xlYW47XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJvdGVjdGVkIG5nWm9uZTogTmdab25lLFxuICAgIHByb3RlY3RlZCBmbGFncz86IEZsYWdzLFxuICAgIHByb3RlY3RlZCBfY2xpZW50PzogQXBvbGxvQ2xpZW50PFRDYWNoZVNoYXBlPixcbiAgKSB7XG4gICAgdGhpcy51c2VJbml0aWFsTG9hZGluZyA9IHBpY2tGbGFnKGZsYWdzLCAndXNlSW5pdGlhbExvYWRpbmcnLCBmYWxzZSk7XG4gIH1cblxuICBwdWJsaWMgd2F0Y2hRdWVyeTxURGF0YSwgVFZhcmlhYmxlcyA9IEVtcHR5T2JqZWN0PihcbiAgICBvcHRpb25zOiBXYXRjaFF1ZXJ5T3B0aW9uczxUVmFyaWFibGVzLCBURGF0YT4sXG4gICk6IFF1ZXJ5UmVmPFREYXRhLCBUVmFyaWFibGVzPiB7XG4gICAgcmV0dXJuIG5ldyBRdWVyeVJlZjxURGF0YSwgVFZhcmlhYmxlcz4oXG4gICAgICB0aGlzLmVuc3VyZUNsaWVudCgpLndhdGNoUXVlcnk8VERhdGEsIFRWYXJpYWJsZXM+KHtcbiAgICAgICAgLi4ub3B0aW9ucyxcbiAgICAgIH0pIGFzIE9ic2VydmFibGVRdWVyeTxURGF0YSwgVFZhcmlhYmxlcz4sXG4gICAgICB0aGlzLm5nWm9uZSxcbiAgICAgIHtcbiAgICAgICAgdXNlSW5pdGlhbExvYWRpbmc6IHRoaXMudXNlSW5pdGlhbExvYWRpbmcsXG4gICAgICAgIC4uLm9wdGlvbnMsXG4gICAgICB9LFxuICAgICk7XG4gIH1cblxuICBwdWJsaWMgcXVlcnk8VCwgViA9IEVtcHR5T2JqZWN0PihcbiAgICBvcHRpb25zOiBRdWVyeU9wdGlvbnM8ViwgVD4sXG4gICk6IE9ic2VydmFibGU8QXBvbGxvUXVlcnlSZXN1bHQ8VD4+IHtcbiAgICByZXR1cm4gZnJvbVByb21pc2U8QXBvbGxvUXVlcnlSZXN1bHQ8VD4+KCgpID0+XG4gICAgICB0aGlzLmVuc3VyZUNsaWVudCgpLnF1ZXJ5PFQsIFY+KHsuLi5vcHRpb25zfSksXG4gICAgKTtcbiAgfVxuXG4gIHB1YmxpYyBtdXRhdGU8VCwgViA9IEVtcHR5T2JqZWN0PihcbiAgICBvcHRpb25zOiBNdXRhdGlvbk9wdGlvbnM8VCwgVj4sXG4gICk6IE9ic2VydmFibGU8RmV0Y2hSZXN1bHQ8VD4+IHtcbiAgICByZXR1cm4gZnJvbVByb21pc2U8RmV0Y2hSZXN1bHQ8VD4+KCgpID0+XG4gICAgICB0aGlzLmVuc3VyZUNsaWVudCgpLm11dGF0ZTxULCBWPih7Li4ub3B0aW9uc30pLFxuICAgICk7XG4gIH1cblxuICBwdWJsaWMgc3Vic2NyaWJlPFQsIFYgPSBFbXB0eU9iamVjdD4oXG4gICAgb3B0aW9uczogU3Vic2NyaXB0aW9uT3B0aW9uczxWLCBUPixcbiAgICBleHRyYT86IEV4dHJhU3Vic2NyaXB0aW9uT3B0aW9ucyxcbiAgKTogT2JzZXJ2YWJsZTxGZXRjaFJlc3VsdDxUPj4ge1xuICAgIGNvbnN0IG9icyA9IGZyb20oXG4gICAgICBmaXhPYnNlcnZhYmxlKFxuICAgICAgICB0aGlzLmVuc3VyZUNsaWVudCgpLnN1YnNjcmliZTxULCBWPih7Li4ub3B0aW9uc30pLFxuICAgICAgKSxcbiAgICApO1xuXG4gICAgcmV0dXJuIGV4dHJhICYmIGV4dHJhLnVzZVpvbmUgIT09IHRydWVcbiAgICAgID8gb2JzXG4gICAgICA6IHdyYXBXaXRoWm9uZShvYnMsIHRoaXMubmdab25lKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgYW4gYWNjZXNzIHRvIGFuIGluc3RhbmNlIG9mIEFwb2xsb0NsaWVudFxuICAgKiBAZGVwcmVjYXRlZCB1c2UgYGFwb2xsby5jbGllbnRgIGluc3RlYWRcbiAgICovXG4gIHB1YmxpYyBnZXRDbGllbnQoKSB7XG4gICAgcmV0dXJuIHRoaXMuY2xpZW50O1xuICB9XG5cbiAgLyoqXG4gICAqIFNldCBhIG5ldyBpbnN0YW5jZSBvZiBBcG9sbG9DbGllbnRcbiAgICogUmVtZW1iZXIgdG8gY2xlYW4gdXAgdGhlIHN0b3JlIGJlZm9yZSBzZXR0aW5nIGEgbmV3IGNsaWVudC5cbiAgICogQGRlcHJlY2F0ZWQgdXNlIGBhcG9sbG8uY2xpZW50ID0gY2xpZW50YCBpbnN0ZWFkXG4gICAqXG4gICAqIEBwYXJhbSBjbGllbnQgQXBvbGxvQ2xpZW50IGluc3RhbmNlXG4gICAqL1xuICBwdWJsaWMgc2V0Q2xpZW50KGNsaWVudDogQXBvbGxvQ2xpZW50PFRDYWNoZVNoYXBlPikge1xuICAgIHRoaXMuY2xpZW50ID0gY2xpZW50O1xuICB9XG5cbiAgLyoqXG4gICAqIEdldCBhbiBhY2Nlc3MgdG8gYW4gaW5zdGFuY2Ugb2YgQXBvbGxvQ2xpZW50XG4gICAqL1xuICBwdWJsaWMgZ2V0IGNsaWVudCgpOiBBcG9sbG9DbGllbnQ8VENhY2hlU2hhcGU+IHtcbiAgICByZXR1cm4gdGhpcy5fY2xpZW50O1xuICB9XG5cbiAgLyoqXG4gICAqIFNldCBhIG5ldyBpbnN0YW5jZSBvZiBBcG9sbG9DbGllbnRcbiAgICogUmVtZW1iZXIgdG8gY2xlYW4gdXAgdGhlIHN0b3JlIGJlZm9yZSBzZXR0aW5nIGEgbmV3IGNsaWVudC5cbiAgICpcbiAgICogQHBhcmFtIGNsaWVudCBBcG9sbG9DbGllbnQgaW5zdGFuY2VcbiAgICovXG4gIHB1YmxpYyBzZXQgY2xpZW50KGNsaWVudDogQXBvbGxvQ2xpZW50PFRDYWNoZVNoYXBlPikge1xuICAgIGlmICh0aGlzLl9jbGllbnQpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignQ2xpZW50IGhhcyBiZWVuIGFscmVhZHkgZGVmaW5lZCcpO1xuICAgIH1cblxuICAgIHRoaXMuX2NsaWVudCA9IGNsaWVudDtcbiAgfVxuXG4gIHByaXZhdGUgZW5zdXJlQ2xpZW50KCkge1xuICAgIHRoaXMuY2hlY2tJbnN0YW5jZSgpO1xuXG4gICAgcmV0dXJuIHRoaXMuX2NsaWVudDtcbiAgfVxuXG4gIHByaXZhdGUgY2hlY2tJbnN0YW5jZSgpOiB2b2lkIHtcbiAgICBpZiAoIXRoaXMuX2NsaWVudCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdDbGllbnQgaGFzIG5vdCBiZWVuIGRlZmluZWQgeWV0Jyk7XG4gICAgfVxuICB9XG59XG5cbkBJbmplY3RhYmxlKHtcbiAgcHJvdmlkZWRJbjogJ3Jvb3QnLFxufSlcbmV4cG9ydCBjbGFzcyBBcG9sbG8gZXh0ZW5kcyBBcG9sbG9CYXNlPGFueT4ge1xuICBwcml2YXRlIG1hcDogTWFwPHN0cmluZywgQXBvbGxvQmFzZTxhbnk+PiA9IG5ldyBNYXA8XG4gICAgc3RyaW5nLFxuICAgIEFwb2xsb0Jhc2U8YW55PlxuICA+KCk7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSBfbmdab25lOiBOZ1pvbmUsXG4gICAgQE9wdGlvbmFsKClcbiAgICBASW5qZWN0KEFQT0xMT19PUFRJT05TKVxuICAgIGFwb2xsb09wdGlvbnM/OiBBcG9sbG9DbGllbnRPcHRpb25zPGFueT4sXG4gICAgQE9wdGlvbmFsKClcbiAgICBASW5qZWN0KEFQT0xMT19OQU1FRF9PUFRJT05TKVxuICAgIGFwb2xsb05hbWVkT3B0aW9ucz86IE5hbWVkT3B0aW9ucyxcbiAgICBAT3B0aW9uYWwoKSBASW5qZWN0KEFQT0xMT19GTEFHUykgZmxhZ3M/OiBGbGFncyxcbiAgKSB7XG4gICAgc3VwZXIoX25nWm9uZSwgZmxhZ3MpO1xuXG4gICAgaWYgKGFwb2xsb09wdGlvbnMpIHtcbiAgICAgIHRoaXMuY3JlYXRlRGVmYXVsdChhcG9sbG9PcHRpb25zKTtcbiAgICB9XG5cbiAgICBpZiAoYXBvbGxvTmFtZWRPcHRpb25zICYmIHR5cGVvZiBhcG9sbG9OYW1lZE9wdGlvbnMgPT09ICdvYmplY3QnKSB7XG4gICAgICBmb3IgKGxldCBuYW1lIGluIGFwb2xsb05hbWVkT3B0aW9ucykge1xuICAgICAgICBpZiAoYXBvbGxvTmFtZWRPcHRpb25zLmhhc093blByb3BlcnR5KG5hbWUpKSB7XG4gICAgICAgICAgY29uc3Qgb3B0aW9ucyA9IGFwb2xsb05hbWVkT3B0aW9uc1tuYW1lXTtcbiAgICAgICAgICB0aGlzLmNyZWF0ZU5hbWVkKG5hbWUsIG9wdGlvbnMpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIENyZWF0ZSBhbiBpbnN0YW5jZSBvZiBBcG9sbG9DbGllbnRcbiAgICogQHBhcmFtIG9wdGlvbnMgT3B0aW9ucyByZXF1aXJlZCB0byBjcmVhdGUgQXBvbGxvQ2xpZW50XG4gICAqIEBwYXJhbSBuYW1lIGNsaWVudCdzIG5hbWVcbiAgICovXG4gIHB1YmxpYyBjcmVhdGU8VENhY2hlU2hhcGU+KFxuICAgIG9wdGlvbnM6IEFwb2xsb0NsaWVudE9wdGlvbnM8VENhY2hlU2hhcGU+LFxuICAgIG5hbWU/OiBzdHJpbmcsXG4gICk6IHZvaWQge1xuICAgIGlmIChpc0RlZmF1bHQobmFtZSkpIHtcbiAgICAgIHRoaXMuY3JlYXRlRGVmYXVsdDxUQ2FjaGVTaGFwZT4ob3B0aW9ucyk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuY3JlYXRlTmFtZWQ8VENhY2hlU2hhcGU+KG5hbWUsIG9wdGlvbnMpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBVc2UgYSBkZWZhdWx0IEFwb2xsb0NsaWVudFxuICAgKi9cbiAgcHVibGljIGRlZmF1bHQoKTogQXBvbGxvQmFzZTxhbnk+IHtcbiAgICByZXR1cm4gdGhpcztcbiAgfVxuXG4gIC8qKlxuICAgKiBVc2UgYSBuYW1lZCBBcG9sbG9DbGllbnRcbiAgICogQHBhcmFtIG5hbWUgY2xpZW50J3MgbmFtZVxuICAgKi9cbiAgcHVibGljIHVzZShuYW1lOiBzdHJpbmcpOiBBcG9sbG9CYXNlPGFueT4ge1xuICAgIGlmIChpc0RlZmF1bHQobmFtZSkpIHtcbiAgICAgIHJldHVybiB0aGlzLmRlZmF1bHQoKTtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMubWFwLmdldChuYW1lKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDcmVhdGUgYSBkZWZhdWx0IEFwb2xsb0NsaWVudCwgc2FtZSBhcyBgYXBvbGxvLmNyZWF0ZShvcHRpb25zKWBcbiAgICogQHBhcmFtIG9wdGlvbnMgQXBvbGxvQ2xpZW50J3Mgb3B0aW9uc1xuICAgKi9cbiAgcHVibGljIGNyZWF0ZURlZmF1bHQ8VENhY2hlU2hhcGU+KFxuICAgIG9wdGlvbnM6IEFwb2xsb0NsaWVudE9wdGlvbnM8VENhY2hlU2hhcGU+LFxuICApOiB2b2lkIHtcbiAgICBpZiAodGhpcy5nZXRDbGllbnQoKSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdBcG9sbG8gaGFzIGJlZW4gYWxyZWFkeSBjcmVhdGVkLicpO1xuICAgIH1cblxuICAgIHJldHVybiB0aGlzLnNldENsaWVudChuZXcgQXBvbGxvQ2xpZW50PFRDYWNoZVNoYXBlPihvcHRpb25zKSk7XG4gIH1cblxuICAvKipcbiAgICogQ3JlYXRlIGEgbmFtZWQgQXBvbGxvQ2xpZW50LCBzYW1lIGFzIGBhcG9sbG8uY3JlYXRlKG9wdGlvbnMsIG5hbWUpYFxuICAgKiBAcGFyYW0gbmFtZSBjbGllbnQncyBuYW1lXG4gICAqIEBwYXJhbSBvcHRpb25zIEFwb2xsb0NsaWVudCdzIG9wdGlvbnNcbiAgICovXG4gIHB1YmxpYyBjcmVhdGVOYW1lZDxUQ2FjaGVTaGFwZT4oXG4gICAgbmFtZTogc3RyaW5nLFxuICAgIG9wdGlvbnM6IEFwb2xsb0NsaWVudE9wdGlvbnM8VENhY2hlU2hhcGU+LFxuICApOiB2b2lkIHtcbiAgICBpZiAodGhpcy5tYXAuaGFzKG5hbWUpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYENsaWVudCAke25hbWV9IGhhcyBiZWVuIGFscmVhZHkgY3JlYXRlZGApO1xuICAgIH1cbiAgICB0aGlzLm1hcC5zZXQoXG4gICAgICBuYW1lLFxuICAgICAgbmV3IEFwb2xsb0Jhc2UoXG4gICAgICAgIHRoaXMuX25nWm9uZSxcbiAgICAgICAgdGhpcy5mbGFncyxcbiAgICAgICAgbmV3IEFwb2xsb0NsaWVudDxUQ2FjaGVTaGFwZT4ob3B0aW9ucyksXG4gICAgICApLFxuICAgICk7XG4gIH1cblxuICAvKipcbiAgICogUmVtZW1iZXIgdG8gY2xlYW4gdXAgdGhlIHN0b3JlIGJlZm9yZSByZW1vdmluZyBhIGNsaWVudFxuICAgKiBAcGFyYW0gbmFtZSBjbGllbnQncyBuYW1lXG4gICAqL1xuICBwdWJsaWMgcmVtb3ZlQ2xpZW50KG5hbWU/OiBzdHJpbmcpOiB2b2lkIHtcbiAgICBpZiAoaXNEZWZhdWx0KG5hbWUpKSB7XG4gICAgICB0aGlzLl9jbGllbnQgPSB1bmRlZmluZWQ7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMubWFwLmRlbGV0ZShuYW1lKTtcbiAgICB9XG4gIH1cbn1cblxuZnVuY3Rpb24gaXNEZWZhdWx0KG5hbWU/OiBzdHJpbmcpOiBib29sZWFuIHtcbiAgcmV0dXJuICFuYW1lIHx8IG5hbWUgPT09ICdkZWZhdWx0Jztcbn1cbiJdfQ==